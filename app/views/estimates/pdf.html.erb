<% content_for(:title) { "Estimate #{@estimate.estimate_number}" } %>

<div class="max-w-4xl mx-auto p-8 bg-white">
  <%# Estimate Header %>
  <div class="flex justify-between items-start mb-10">
    <div>
      <div class="gradient-header px-6 py-3 rounded-lg inline-block mb-4">
        <h1 class="text-3xl font-bold text-white tracking-tight">ESTIMATE</h1>
      </div>
      <p class="text-xl font-semibold text-slate-700"><%= @estimate.estimate_number %></p>
    </div>
    <div class="text-right">
      <% if @estimate.account.respond_to?(:name) && @estimate.account.name.present? %>
        <p class="text-xl font-bold text-slate-900"><%= @estimate.account.name %></p>
      <% end %>
      <p class="text-sm text-slate-500 mt-1">Issue Date: <span class="font-medium text-slate-700"><%= @estimate.issue_date.strftime("%B %d, %Y") %></span></p>
      <p class="text-sm text-slate-500">Valid Until: <span class="font-medium <%= @estimate.expired? ? 'text-red-600' : 'text-slate-700' %>"><%= @estimate.valid_until.strftime("%B %d, %Y") %></span></p>
    </div>
  </div>

  <%# Status Badge %>
  <% case @estimate.status.to_sym %>
  <% when :accepted %>
    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-8 flex items-center gap-3">
      <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
        <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
        </svg>
      </div>
      <div>
        <p class="font-semibold text-green-800">ACCEPTED</p>
        <% if @estimate.accepted_at.present? %>
          <p class="text-sm text-green-600">Accepted on <%= @estimate.accepted_at.strftime("%B %d, %Y") %></p>
        <% end %>
      </div>
    </div>
  <% when :declined %>
    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-8 flex items-center gap-3">
      <div class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center">
        <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </div>
      <div>
        <p class="font-semibold text-red-800">DECLINED</p>
        <% if @estimate.declined_at.present? %>
          <p class="text-sm text-red-600">Declined on <%= @estimate.declined_at.strftime("%B %d, %Y") %></p>
        <% end %>
      </div>
    </div>
  <% when :expired %>
    <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-8 flex items-center gap-3">
      <div class="w-8 h-8 bg-amber-500 rounded-full flex items-center justify-center">
        <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
        </svg>
      </div>
      <div>
        <p class="font-semibold text-amber-800">EXPIRED</p>
        <p class="text-sm text-amber-600">This estimate is no longer valid</p>
      </div>
    </div>
  <% when :converted %>
    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-8 flex items-center gap-3">
      <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center">
        <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </div>
      <div>
        <p class="font-semibold text-purple-800">CONVERTED TO INVOICE</p>
        <% if @estimate.converted_at.present? %>
          <p class="text-sm text-purple-600">Converted on <%= @estimate.converted_at.strftime("%B %d, %Y") %></p>
        <% end %>
      </div>
    </div>
  <% end %>

  <%# Prepared For Section %>
  <div class="grid grid-cols-2 gap-8 mb-10">
    <div class="bg-slate-50 rounded-lg p-6">
      <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3">Prepared For</p>
      <p class="text-lg font-bold text-slate-900"><%= @estimate.client.name %></p>
      <% if @estimate.client.company.present? %>
        <p class="text-slate-600 mt-1"><%= @estimate.client.company %></p>
      <% end %>
      <% if @estimate.client.respond_to?(:address) && @estimate.client.address.present? %>
        <p class="text-slate-500 text-sm mt-2"><%= simple_format(@estimate.client.address, {}, wrapper_tag: "span") %></p>
      <% end %>
      <% if @estimate.client.email.present? %>
        <p class="text-slate-500 text-sm mt-2"><%= @estimate.client.email %></p>
      <% end %>
      <% if @estimate.client.phone.present? %>
        <p class="text-slate-500 text-sm"><%= @estimate.client.phone %></p>
      <% end %>
    </div>

    <% if @estimate.project.present? %>
      <div class="bg-slate-50 rounded-lg p-6">
        <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3">Project</p>
        <p class="text-lg font-bold text-slate-900"><%= @estimate.project.name %></p>
        <% if @estimate.project.respond_to?(:description) && @estimate.project.description.present? %>
          <p class="text-slate-500 text-sm mt-2"><%= truncate(@estimate.project.description, length: 100) %></p>
        <% end %>
      </div>
    <% end %>
  </div>

  <%# Line Items Table %>
  <div class="mb-8 avoid-break">
    <table class="w-full">
      <thead>
        <tr class="bg-slate-800 text-white">
          <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider rounded-tl-lg">Description</th>
          <th class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wider w-24">Qty</th>
          <th class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wider w-32">Unit Price</th>
          <th class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wider w-32 rounded-tr-lg">Amount</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-200">
        <% if @estimate.line_items.any? %>
          <% @estimate.line_items.each_with_index do |item, index| %>
            <tr class="<%= index.even? ? 'bg-white' : 'bg-slate-50' %>">
              <td class="px-4 py-4 text-sm text-slate-900"><%= item.description %></td>
              <td class="px-4 py-4 text-sm text-slate-600 text-right"><%= number_with_precision(item.quantity, precision: 2, strip_insignificant_zeros: true) %></td>
              <td class="px-4 py-4 text-sm text-slate-600 text-right"><%= number_to_currency(item.unit_price) %></td>
              <td class="px-4 py-4 text-sm font-medium text-slate-900 text-right"><%= number_to_currency(item.amount) %></td>
            </tr>
          <% end %>
        <% else %>
          <tr>
            <td colspan="4" class="px-4 py-8 text-center text-slate-400 italic">No line items</td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <%# Totals Section %>
  <div class="flex justify-end mb-10">
    <div class="w-80">
      <div class="bg-slate-50 rounded-lg p-6">
        <div class="space-y-3">
          <div class="flex justify-between text-sm">
            <span class="text-slate-600">Subtotal</span>
            <span class="font-medium text-slate-900"><%= number_to_currency(@estimate.subtotal) %></span>
          </div>
          <% if @estimate.tax_rate.present? && @estimate.tax_rate > 0 %>
            <div class="flex justify-between text-sm">
              <span class="text-slate-600">Tax (<%= @estimate.tax_rate %>%)</span>
              <span class="font-medium text-slate-900"><%= number_to_currency(@estimate.tax_amount) %></span>
            </div>
          <% end %>
          <% if @estimate.discount_amount.present? && @estimate.discount_amount > 0 %>
            <div class="flex justify-between text-sm">
              <span class="text-slate-600">Discount</span>
              <span class="font-medium text-red-600">-<%= number_to_currency(@estimate.discount_amount) %></span>
            </div>
          <% end %>
          <div class="border-t border-slate-300 pt-3 mt-3">
            <div class="flex justify-between">
              <span class="text-lg font-bold text-slate-900">Total</span>
              <span class="text-2xl font-bold text-slate-900"><%= number_to_currency(@estimate.total_amount) %></span>
            </div>
          </div>
        </div>
      </div>

      <% unless @estimate.expired? || @estimate.declined? || @estimate.converted? %>
        <div class="mt-4 text-center">
          <p class="text-sm text-slate-500">Valid until <span class="font-semibold text-slate-700"><%= @estimate.valid_until.strftime("%B %d, %Y") %></span></p>
          <% if @estimate.days_until_expiry <= 7 && @estimate.days_until_expiry > 0 %>
            <p class="text-xs text-amber-600 mt-1">(<%= @estimate.days_until_expiry %> days remaining)</p>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <%# Notes and Terms %>
  <% if @estimate.notes.present? || @estimate.terms.present? %>
    <div class="border-t border-slate-200 pt-8 space-y-6 avoid-break">
      <% if @estimate.notes.present? %>
        <div>
          <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">Notes</p>
          <div class="text-sm text-slate-600 bg-slate-50 rounded-lg p-4">
            <%= simple_format(@estimate.notes) %>
          </div>
        </div>
      <% end %>

      <% if @estimate.terms.present? %>
        <div>
          <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">Terms & Conditions</p>
          <div class="text-xs text-slate-500 bg-slate-50 rounded-lg p-4">
            <%= simple_format(@estimate.terms) %>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>

  <%# Footer %>
  <div class="mt-12 pt-6 border-t border-slate-200 text-center">
    <p class="text-sm text-slate-500">Thank you for considering our services!</p>
    <p class="text-xs text-slate-400 mt-2">Estimate generated on <%= Time.current.strftime("%B %d, %Y at %I:%M %p") %></p>
  </div>
</div>
