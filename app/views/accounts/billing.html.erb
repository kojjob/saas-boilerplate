<% content_for :page_title, "Billing & Subscription" %>

<div class="space-y-6">
  <%# Page Header %>
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
    <div>
      <h1 class="text-2xl font-bold text-slate-900">Billing & Subscription</h1>
      <p class="mt-1 text-sm text-slate-500">Manage your subscription and billing information</p>
    </div>
    <div class="mt-4 sm:mt-0">
      <%= link_to account_path, class: "inline-flex items-center px-4 py-2 border border-slate-300 text-slate-700 text-sm font-medium rounded-lg hover:bg-slate-50 transition-colors" do %>
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Back to Account
      <% end %>
    </div>
  </div>

  <%# Current Plan Card %>
  <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
    <div class="px-6 py-4 border-b border-slate-200 bg-gradient-to-r from-indigo-600 to-purple-600">
      <h3 class="text-lg font-semibold text-white">Current Plan</h3>
      <p class="text-sm text-indigo-100">Your active subscription details</p>
    </div>
    <div class="p-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
        <div class="flex items-center space-x-4">
          <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg shadow-indigo-500/25">
            <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" />
            </svg>
          </div>
          <div>
            <p class="text-xl font-bold text-slate-900">
              <%= @current_plan&.name || 'Free Plan' %>
            </p>
            <% if @current_plan && !@current_plan.free? %>
              <p class="text-slate-500">
                <span class="text-2xl font-bold text-slate-900"><%= @current_plan.formatted_price %></span>
                <span class="text-slate-400">/<%= @current_plan.interval %></span>
              </p>
            <% else %>
              <p class="text-slate-500">No cost - enjoy the basic features</p>
            <% end %>
          </div>
        </div>
        <div class="mt-4 sm:mt-0">
          <%= render_subscription_badge(@account.subscription_status) %>
        </div>
      </div>

      <% if @account.subscription_status == 'trialing' && @account.trial_ends_at.present? %>
        <div class="mt-4 p-4 rounded-lg bg-blue-50 border border-blue-100">
          <div class="flex items-center">
            <svg class="w-5 h-5 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <p class="text-sm text-blue-800">
              Your trial ends on <strong><%= @account.trial_ends_at.strftime("%B %d, %Y") %></strong>
              (<%= distance_of_time_in_words_to_now(@account.trial_ends_at) %> remaining)
            </p>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <%# Available Plans %>
  <div class="space-y-4">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-semibold text-slate-900">Available Plans</h3>
      <p class="text-sm text-slate-500">Choose the plan that best fits your needs</p>
    </div>

    <div class="grid gap-6 lg:grid-cols-3">
      <% @plans.each_with_index do |plan, index| %>
        <% is_current = @current_plan == plan %>
        <% is_popular = index == 1 %>
        <div class="relative bg-white rounded-xl shadow-sm border-2 <%= is_current ? 'border-indigo-500 ring-2 ring-indigo-500/20' : is_popular ? 'border-purple-500' : 'border-slate-200' %> overflow-hidden flex flex-col">
          <% if is_popular && !is_current %>
            <div class="absolute top-0 right-0">
              <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white text-xs font-semibold px-3 py-1 rounded-bl-lg">
                Most Popular
              </div>
            </div>
          <% end %>

          <% if is_current %>
            <div class="absolute top-0 left-0 right-0">
              <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white text-xs font-semibold px-4 py-1.5 text-center">
                Current Plan
              </div>
            </div>
          <% end %>

          <div class="p-6 <%= is_current ? 'pt-10' : '' %> flex-1 flex flex-col">
            <%# Plan Header %>
            <div class="text-center mb-6">
              <div class="w-12 h-12 mx-auto rounded-xl <%= plan.free? ? 'bg-slate-100' : 'bg-gradient-to-br from-indigo-500 to-purple-600' %> flex items-center justify-center mb-4">
                <% if plan.free? %>
                  <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                <% else %>
                  <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                  </svg>
                <% end %>
              </div>
              <h4 class="text-xl font-bold text-slate-900"><%= plan.name %></h4>
              <div class="mt-2">
                <% if plan.free? %>
                  <span class="text-4xl font-bold text-slate-900">Free</span>
                <% else %>
                  <span class="text-4xl font-bold text-slate-900"><%= plan.formatted_price %></span>
                  <span class="text-slate-500">/<%= plan.interval %></span>
                <% end %>
              </div>
              <% if plan.description.present? %>
                <p class="mt-2 text-sm text-slate-500"><%= plan.description %></p>
              <% end %>
            </div>

            <%# Features List %>
            <ul class="space-y-3 flex-1">
              <% plan.features&.each do |feature| %>
                <li class="flex items-start">
                  <div class="flex-shrink-0 w-5 h-5 rounded-full bg-green-100 flex items-center justify-center mr-3 mt-0.5">
                    <svg class="w-3 h-3 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                  </div>
                  <span class="text-sm text-slate-600"><%= feature %></span>
                </li>
              <% end %>
            </ul>

            <%# Action Button %>
            <div class="mt-6">
              <% if is_current %>
                <span class="block w-full text-center px-4 py-3 border-2 border-slate-200 rounded-lg text-sm font-medium text-slate-500 bg-slate-50 cursor-not-allowed">
                  <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  Current Plan
                </span>
              <% else %>
                <% is_upgrade = @current_plan.present? && @current_plan.price_cents < plan.price_cents %>
                <%= link_to billing_checkout_path(plan_id: plan.id),
                    method: :post,
                    class: "block w-full text-center px-4 py-3 rounded-lg text-sm font-medium transition-all duration-200 #{is_upgrade ? 'bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg shadow-indigo-500/25 hover:shadow-indigo-500/40' : 'border-2 border-slate-300 text-slate-700 hover:bg-slate-50'}" do %>
                  <% if is_upgrade %>
                    <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                    </svg>
                    Upgrade Now
                  <% elsif plan.free? %>
                    Downgrade
                  <% else %>
                    Select Plan
                  <% end %>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <%# Billing Management Card %>
  <div class="bg-white rounded-xl shadow-sm border border-slate-200">
    <div class="px-6 py-4 border-b border-slate-200">
      <h3 class="text-lg font-semibold text-slate-900">Billing Management</h3>
      <p class="text-sm text-slate-500">Access your payment history and manage billing settings</p>
    </div>
    <div class="p-6">
      <div class="grid gap-4 sm:grid-cols-2">
        <%# Billing Portal Button %>
        <div class="flex items-start space-x-4 p-4 rounded-lg border border-slate-200 hover:border-indigo-300 hover:bg-indigo-50/50 transition-colors">
          <div class="w-10 h-10 rounded-lg bg-indigo-100 flex items-center justify-center flex-shrink-0">
            <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
            </svg>
          </div>
          <div class="flex-1">
            <h4 class="text-sm font-medium text-slate-900">Payment Methods</h4>
            <p class="text-sm text-slate-500 mt-1">Update your credit card or payment method</p>
            <%= link_to billing_portal_path, class: "inline-flex items-center text-sm font-medium text-indigo-600 hover:text-indigo-700 mt-2" do %>
              Open Portal
              <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
            <% end %>
          </div>
        </div>

        <%# Invoice History %>
        <div class="flex items-start space-x-4 p-4 rounded-lg border border-slate-200 hover:border-purple-300 hover:bg-purple-50/50 transition-colors">
          <div class="w-10 h-10 rounded-lg bg-purple-100 flex items-center justify-center flex-shrink-0">
            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
          </div>
          <div class="flex-1">
            <h4 class="text-sm font-medium text-slate-900">Invoice History</h4>
            <p class="text-sm text-slate-500 mt-1">View and download your past invoices</p>
            <%= link_to billing_portal_path, class: "inline-flex items-center text-sm font-medium text-purple-600 hover:text-purple-700 mt-2" do %>
              View Invoices
              <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
            <% end %>
          </div>
        </div>
      </div>

      <%# Help Section %>
      <div class="mt-6 p-4 rounded-lg bg-slate-50 border border-slate-200">
        <div class="flex items-center">
          <svg class="w-5 h-5 text-slate-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <div>
            <p class="text-sm text-slate-600">
              Need help with billing? Contact our support team at
              <a href="mailto:support@deployable.co" class="text-indigo-600 hover:text-indigo-700 font-medium">support@deployable.co</a>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <%# Cancel Subscription (if applicable) %>
  <% if @account.subscription_status == 'active' && @current_plan && !@current_plan.free? %>
    <div class="bg-white rounded-xl shadow-sm border border-amber-200">
      <div class="px-6 py-4 border-b border-amber-100 bg-amber-50 rounded-t-xl">
        <h3 class="text-lg font-semibold text-amber-900">Subscription Management</h3>
        <p class="text-sm text-amber-600">Actions for your current subscription</p>
      </div>
      <div class="p-6">
        <div class="flex items-center justify-between">
          <div>
            <h4 class="text-sm font-medium text-slate-900">Cancel Subscription</h4>
            <p class="text-sm text-slate-500 mt-1">
              You can cancel your subscription at any time. Your access will continue until the end of your billing period.
            </p>
          </div>
          <%= link_to billing_portal_path, class: "flex-shrink-0 px-4 py-2 border border-amber-300 text-amber-700 text-sm font-medium rounded-lg hover:bg-amber-50 transition-colors" do %>
            Manage Subscription
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
</div>
